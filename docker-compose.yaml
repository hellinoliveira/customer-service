# =============================================================================
# Pedalando Ali - Customer Service Infrastructure
# =============================================================================
# Self-contained stack with dedicated Redis, PostgreSQL, Evolution API, and Kestra
# Does NOT share resources with the existing bot-wpp infrastructure
# Evolution API v2.2.3 + Kestra v1.1.0+
# =============================================================================

services:
  # ----------------------------------------------------------------
  # BANCO DE DADOS (PostgreSQL)
  # Usado pelo Kestra (flow storage) e Evolution (sessions)
  # ----------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: pedalando_postgres
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_MULTIPLE_DATABASES: "${POSTGRES_DB_KESTRA},${POSTGRES_DB_EVOLUTION}"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-multiple-dbs.sh:/docker-entrypoint-initdb.d/init-multiple-dbs.sh
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - pedalando_net

  # ----------------------------------------------------------------
  # REDIS (Dedicado para Customer Service)
  # Usado para cache do Evolution e state management do Kestra flows
  # ----------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: pedalando_redis
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - pedalando_net

  # ----------------------------------------------------------------
  # EVOLUTION API v2.2.2
  # Gateway de WhatsApp - InstÃ¢ncia: pedalandoali
  # Docs: https://doc.evolution-api.com/v2
  # ----------------------------------------------------------------
  evolution-api:
    image: evoapicloud/evolution-api
    container_name: pedalando_evolution
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    ports:
      - "${EVOLUTION_PORT}:8080"
    volumes:
      - evolution_instances:/evolution/instances
      - evolution_store:/evolution/store
    environment:
      # --- Server ---
      SERVER_TYPE: http
      SERVER_PORT: 8080
      SERVER_URL: ${SERVER_URL}

      # --- Authentication (v2 usa apenas AUTHENTICATION_API_KEY) ---
      AUTHENTICATION_API_KEY: ${AUTHENTICATION_API_KEY}
      AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES: ${AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES:-true}

      # --- Database (PostgreSQL) ---
      DATABASE_ENABLED: "true"
      DATABASE_PROVIDER: postgresql
      DATABASE_CONNECTION_URI: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB_EVOLUTION}?schema=public
      DATABASE_CONNECTION_CLIENT_NAME: pedalandoali
      DATABASE_SAVE_DATA_INSTANCE: "true"
      DATABASE_SAVE_DATA_NEW_MESSAGE: "false"
      DATABASE_SAVE_MESSAGE_UPDATE: "false"
      DATABASE_SAVE_DATA_CONTACTS: "false"
      DATABASE_SAVE_DATA_CHATS: "false"

      # --- Cache (Redis) ---
      CACHE_REDIS_ENABLED: "true"
      CACHE_REDIS_URI: redis://:${REDIS_PASSWORD}@redis:6379/0
      CACHE_REDIS_PREFIX_KEY: evolution
      CACHE_REDIS_SAVE_INSTANCES: "true"
      CACHE_LOCAL_ENABLED: "false"

      # --- Webhook Global -> Kestra ---
      WEBHOOK_GLOBAL_ENABLED: "false"
      WEBHOOK_GLOBAL_URL: http://kestra:8080/api/v1/executions/webhook/pedalandoali/pedalandoali-customer-service/pedalandoali-cs-webhook
      WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS: "false"
      WEBHOOK_EVENTS_QRCODE_UPDATED: "true"
      WEBHOOK_EVENTS_MESSAGES_UPSERT: "true"
      WEBHOOK_EVENTS_MESSAGES_UPDATE: "false"
      WEBHOOK_EVENTS_SEND_MESSAGE: "false"
      WEBHOOK_EVENTS_CONNECTION_UPDATE: "true"

      # --- QR Code ---
      QRCODE_LIMIT: 10
      QRCODE_COLOR: "#000000"

      # # --- Instance Config ---
      CONFIG_SESSION_PHONE_CLIENT: Pedalando Ali
      CONFIG_SESSION_PHONE_NAME: Chrome
      # CRITICAL: This version must match WhatsApp's current protocol
      # See: https://github.com/EvolutionAPI/evolution-api/issues/1014
      CONFIG_SESSION_PHONE_VERSION: "2.3000.1025062854"

      # --- Logging (DEBUG temporarily to diagnose QR code issue) ---
      LOG_LEVEL: DEBUG
      LOG_COLOR: "true"
      LOG_BAILEYS: info

      # --- Other ---
      TELEMETRY_ENABLED: "false"
      CORS_ORIGIN: "*"
      CORS_METHODS: GET,POST,PUT,DELETE
      CORS_CREDENTIALS: "true"
      LANGUAGE: pt-BR
    networks:
      - pedalando_net

  # ----------------------------------------------------------------
  # KESTRA v1.1.0+
  # Maestro dos fluxos de atendimento
  # ----------------------------------------------------------------
  kestra:
    image: kestra/kestra:latest
    pull_policy: always
    container_name: pedalando_kestra
    restart: always
    user: "root"
    command: server standalone --worker-thread=128
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    ports:
      - "${KESTRA_PORT}:8080"
      - "${KESTRA_MANAGEMENT_PORT}:8081"
    environment:
      KESTRA_CONFIGURATION: |
        datasources:
          postgres:
            url: jdbc:postgresql://postgres:5432/${POSTGRES_DB_KESTRA}
            driverClassName: org.postgresql.Driver
            username: ${POSTGRES_USER}
            password: ${POSTGRES_PASSWORD}
        kestra:
          server:
            basic-auth:
              enabled: true
              username: ${KESTRA_ADMIN_USER}
              password: ${KESTRA_ADMIN_PASSWORD}
          url: http://localhost:${KESTRA_PORT}/
          queue:
            type: postgres
          repository:
            type: postgres
          storage:
            type: local
            local:
              base-path: /app/storage
          tasks:
            tmp-dir:
              path: /tmp/kestra-wd/tmp
          plugins:
            repositories:
              central:
                url: https://repo.maven.apache.org/maven2/

      # Secrets for flows (access via {{ secret('KEY') }})
      # IMPORTANT: All SECRET_* values must be base64 encoded!
      # To encode: echo -n 'value' | base64
      SECRET_EVOLUTION_API_URL: aHR0cDovL2V2b2x1dGlvbi1hcGk6ODA4MA==
      SECRET_EVOLUTION_API_KEY: NDdlODVhYmE2ZjU3YjQ4ZjhlZWFlNmMwMTE0NGY2YTY=
      SECRET_REDIS_HOST: cmVkaXM=
      SECRET_REDIS_PORT: NjM3OQ==
      SECRET_REDIS_PASSWORD: cmVkaXNfc2VjdXJlX3Bhc3M=
    volumes:
      - kestra_storage:/app/storage
      - ./kestra:/app/flows
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/kestra-wd:/tmp/kestra-wd
    networks:
      - pedalando_net

networks:
  pedalando_net:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  evolution_instances:
  evolution_store:
  kestra_storage:
